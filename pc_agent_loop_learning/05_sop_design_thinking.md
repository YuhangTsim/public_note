# 05: SOP 设计思路 - 对比其他框架的实现方案

> 本文档记录关于 GenericAgent SOP 自举能力在其他框架（OpenCode/Roo-Code）中实现的设计思路分析。
> 
> 分析日期：2026-02-28

---

## 1. 核心设计问题

### Q1: 核心实现 vs 插件？

| 方案 | 优点 | 缺点 |
|------|------|------|
| **核心 (OpenCode 内建)** | 权限/会话感知/压缩一体化 | 耦合深，改动大 |
| **插件 (oh-my-opencode)** | 快速实验，独立演进 | 访问 API 有限 |

**结论**：插件优先

**理由**：
- SOP 本质是"用户数据"，不是框架核心能力
- 插件可以先跑通闭环，验证假设后再考虑是否下沉
- 减少核心复杂度，避免"功能蔓延"

---

### Q2: "验证成功"的阈值设计？

这是**最关键的设计问题**。有三条路：

#### 方案 A：宽松派（像 GenericAgent）

```
触发条件：LLM 自己判断"值得记录"
```

- 优点：灵活，LLM 有主观判断
- 缺点：容易"记错东西"，错误传播

#### 方案 B：严格派（必须通过测试）

```
触发条件：exit code = 0 + 至少有 1 个工具调用成功
```

- 优点：客观，可量化
- 缺点：很多"软技能"无法记录（如"如何和用户沟通"）

#### 方案 C：信任累积派（推荐）

```
第一次写成 Draft → 需要再成功一次 → 升级 Verified → N次成功 → Stable
```

**设计思路**：

```
Draft (草稿)
  │
  ├── 手动触发 / 特定关键词触发
  │
  ▼
使用 1 次 ──成功──▶ Verified (已验证)
  │                      │
  │                      ▼
  └── 失败 ──────────▶ 降级为 Draft
  
Verified ──成功 N 次──▶ Stable (稳定版)
        │                    │
        └── 失败 2 次 ──▶ 禁用，等待人工审核
```

**信号类型与可靠性**：

| 信号类型 | 例子 | 可靠性 |
|----------|------|--------|
| **硬** | `exit_code == 0`, `pytest passed` | 高 |
| **软** | 用户说"好的"/"完美" | 中 |
| **行为** | 同一 SOP 被调用 3 次都成功 | 中 |
| **沉默** | 用户没反馈，但也没报错 | 低 |

---

### Q3: SOP 能否跨项目？

**Scope 设计**：

```
├── user (个人)     ~/.opencode/skills/
├── project (项目)   ./.opencode/skills/
└── global (全局)   框架内置
```

**结论**：默认 project 级别

**理由**：SOP 包含路径/依赖/配置，跨项目容易出错

---

## 2. 调用模式设计

### 三种模式

| 模式 | 描述 | 风险 |
|------|------|------|
| **手动** | 用户显式调用 `/sop xxx` | 低 |
| **建议** | Agent 说"可以用 SOP xxx，要试试吗" | 中 |
| **自动** | Agent 直接加载 SOP 执行 | 高 |

### 渐进路径

```
Phase 1: 手动调用
  → 用户知道有哪些 SOP，自己决定用不用
  
Phase 2: 建议模式
  → Agent 识别任务匹配 SOP，询问用户
  
Phase 3: 自动模式
  → 只有 Verified/Stable 级别的 SOP 才自动加载
```

**核心原则**：**让 SOP 的"自动性"和"可信度"成正比**

---

## 3. 框架对比

| 维度 | GenericAgent | OpenCode | Roo-Code | oh-my-opencode |
|------|-------------|----------|----------|----------------|
| **SOP 载体** | 纯文本 Markdown | SKILL.md (已有) | 无 | 可复用 Skill |
| **写入触发** | `start_long_term_update` | **无** | 无 | 可通过 hook |
| **验证机制** | "验证成功"约束 | 无 | 无 | 可新增 |
| **迁移难度** | 原生 | **中等** | 高 | **低~中** |

---

## 4. 关键结论

### 最佳路径

**SOP → Skill + 两阶段验证 + 低侵入索引**

### 设计哲学

GenericAgent 的"自举"本质是：
> **让 Agent 变成自己的工具开发者**

但它忽略了：**工具开发者需要质量保证**。

所以设计重点不是"如何让 Agent 记录 SOP"，而是：
> **如何建立一个让 Agent 记录"好"SOP 的系统**

---

## 5. 待确认问题

1. **核心功能还是插件实现？**
2. **"验证成功"的最低门槛是什么？** (推荐：信任累积 Draft→Verified→Stable)
3. **SOP 是否允许跨项目共享？** (推荐：默认 project 级别)
